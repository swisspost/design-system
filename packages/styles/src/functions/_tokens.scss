@use 'sass:meta';
@use 'sass:map';
@use 'sass:list';
@use './string';

$_namespace: 'post';
$default-map: null !default;

/**
 * @function get($key, $map)
 * Gets a token-key, normalizes and resolves it with the given map or $default-map.
 *
 * @param {string} $key - The full token key (including prefix).
 * @param {map} $map - The map to get the token key from (optional).
 *
 * @returns {any} $value of $normalized-key in the specified map
 *
 * @example
 * @use '../tokens/components';
 * @use '../functions/tokens';
 *
 * // set the default map to use or always use the second function parameter to specify a different map.
 * tokens.$default-map: components.$post-badge;
 *
 * selector {
 *   background-color: tokens.get('post-badge-bg');
 *   color: tokens.get('badge-fg');
 *   border-width: tokens.get('app-store-focus-outline-width', components.$post-app-store-badge);  // use a different map than the default one
 * }
 */
@function get($key, $map: $default-map) {
  $normalized-key: normalize-key($key);

  @if not meta.type-of($map) == 'map' {
    @error 'No map provided or provided $map is not valid. Got #{meta.type-of($map)} instead.';
  }

  @if not map.has-key($map, $normalized-key) {
    @error 'No such key "#{$normalized-key}" in given map! Available keys are: #{meta.inspect(map.keys($map))}.';
  }

  @return map.get($map, $normalized-key);
}

/**
 * Returns a map of tokens matching a given key.
 *
 * Example:
 * @use './tokens/utilities';
 * @use './functions/tokens';
 *
 * @debug tokens.map('utility-font-size', utilities.$post-typo);
 * // (none: var(--post-core-letter-spacing-none), default: var(--post-core-letter-spacing-default))
 *
 * tokens.$default-map: utilities.$post-typo;
 * @debug tokens.map('utility-font-size');
 * // (sm: var(--post-device-font-size-7), md: var(--post-device-font-size-6), lg: var(--post-device-font-size-5))
 */
@function map($key, $map: $default-map) {
  $normalized-key: '#{normalize-key($key)}-';

  @if not meta.type-of($map) == 'map' {
    @error 'No map provided or provided $map is not valid. Got #{meta.type-of($map)} instead.';
  }

  $values: ();
  @each $token, $value in $map {
    @if (string.contains($token, $normalized-key)) {
      $new-value: (
        string.replace($token, $normalized-key, ''): $value,
      );

      $values: map.merge($values, $new-value);
    }
  }

  @if (list.length($values) == 0) {
    @error 'No token matching "#{$normalized-key}*" was found in the provided map.';
  }

  @return $values;
}

@function normalize-key($key) {
  $key-parts: string.split($key, '-');
  $key-contains-namespace: list.nth($key-parts, 1) == $_namespace;

  @if not $key-contains-namespace {
    $key: '#{$_namespace}-#{$key}';
  }

  @return $key;
}
