name: Visual Regression Tests
on:
  pull_request:
    paths:
      - 'packages/components/**'
  workflow_dispatch:
    inputs:
      update-snapshots:
        description: 'Update visual snapshots'
        type: boolean
        default: false

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  visual-tests-components:
    name: Visual Tests - Components
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup-pnpm

      - name: Install dependencies and build packages
        run: pnpm bootstrap

      - name: Install Playwright browsers
        working-directory: packages/components
        run: npx playwright install --with-deps

      # STEP 1: Generate fresh snapshots and update cache
      - name: Generate fresh snapshots for comprehensive tests
        working-directory: packages/components
        run: |
          echo "ðŸ”„ Generating fresh snapshots for comprehensive test suite..."
          rm -rf visual-tests/__screenshots__
          pnpm test:visual:update

      - name: Run visual tests
        working-directory: packages/components
        run: pnpm test:visual

      # Save new snapshots to cache
      - name: Save updated snapshots to cache
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684
        with:
          path: packages/components/visual-tests/__screenshots__
          key: visual-snapshots-components-${{ github.ref }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: playwright-report-components
          path: packages/components/test-results
          retention-days: 14

      - name: Upload generated screenshots
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: generated-screenshots
          path: packages/components/visual-tests/__screenshots__
          retention-days: 14

      - name: Upload diff screenshots
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: playwright-screenshots-components
          path: |
            packages/components/test-results/**/*-diff.png
            packages/components/test-results/**/*-actual.png
            packages/components/test-results/**/*-expected.png
          retention-days: 14
          