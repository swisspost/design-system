name: Visual Regression Tests

on:
  pull_request:
    paths:
      - 'packages/components/**'
  push:
    branches:
      - main
    paths:
      - 'packages/components/**'
  workflow_dispatch:
    inputs:
      update-snapshots:
        description: 'Force update visual snapshots'
        type: boolean
        default: false

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  visual-tests-components:
    name: Visual Tests - Components (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup-pnpm

      - name: Install dependencies and build packages
        run: pnpm bootstrap

      - name: Cache Playwright browsers
        uses: actions/cache@ab5e6d0c87105b4c9c2047343972218f562e4319 # v4.1.0
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        working-directory: packages/components
        run: npx playwright install --with-deps

      - name: Get baseline snapshots from cache
        id: snapshot-cache
        uses: actions/cache@ab5e6d0c87105b4c9c2047343972218f562e4319 # v4.1.0
        with:
          path: packages/components/visual-tests/__screenshots__
          key: visual-snapshots-main-${{ hashFiles('packages/components/src/**/*.{tsx,ts,scss}') }}
          restore-keys: |
            visual-snapshots-main-
      
      # Определяем условие один раз для переиспользования
      - name: Check if baseline update needed
        id: should-update
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ steps.snapshot-cache.outputs.cache-hit }}" != "true" ]] || [[ "${{ github.event.inputs.update-snapshots }}" == "true" ]]; then
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate baseline snapshots
        if: steps.should-update.outputs.update == 'true'
        working-directory: packages/components
        run: pnpm test:visual:update --shard=${{ matrix.shard }}/${{ strategy.job-total }}

      - name: Optimize PNG screenshots
        if: steps.should-update.outputs.update == 'true'
        run: |
          sudo apt-get install -y pngquant
          find packages/components/visual-tests/__screenshots__ -name "*.png" -exec pngquant --force --ext .png --quality 80-95 {} \;

      - name: Run visual regression tests
        working-directory: packages/components
        run: pnpm test:visual --shard=${{ matrix.shard }}/${{ strategy.job-total }}

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.5.0
        with:
          name: playwright-report-components-shard-${{ matrix.shard }}
          path: packages/components/test-results
          retention-days: 14

      - name: Upload diff screenshots
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.5.0
        with:
          name: playwright-screenshots-components-shard-${{ matrix.shard }}
          path: |
            packages/components/test-results/**/*-diff.png
            packages/components/test-results/**/*-actual.png
            packages/components/test-results/**/*-expected.png
          retention-days: 14