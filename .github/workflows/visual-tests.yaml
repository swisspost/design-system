name: Visual Regression Tests

on:
  pull_request:
    paths:
      - 'packages/components/**'
  push:
    branches:
      - main
      - 'release/**'
    paths:
      - 'packages/components/**'
  workflow_dispatch:
    inputs:
      update-snapshots:
        description: 'Force update visual snapshots'
        type: boolean
        default: false

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  visual-tests-components:
    name: Visual Tests - Components
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup-pnpm

      - name: Install dependencies and build packages
        run: pnpm bootstrap

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        working-directory: packages/components
        run: npx playwright install --with-deps

      - name: Determine baseline branch
        id: baseline
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASELINE_BRANCH="${{ github.base_ref }}"
          else
            BASELINE_BRANCH="${{ github.ref_name }}"
          fi
          echo "branch=$BASELINE_BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ“ Using baseline from branch: $BASELINE_BRANCH"

      - name: Get baseline snapshots from cache
        id: snapshot-cache
        uses: actions/cache@v4
        with:
          path: packages/components/vrt/__screenshots__
          key: vrt-${{ steps.baseline.outputs.branch }}-${{ hashFiles('packages/components/src/**/*.scss', 'packages/components/src/**/*.tsx') }}
          restore-keys: |
            vrt-${{ steps.baseline.outputs.branch }}-

      - name: Check if baseline update needed
        id: should-update
        run: |
          UPDATE=false
          
          # ÐÐµÑ‚ ÐºÑÑˆÐ° Ð½Ð° main/release Ð²ÐµÑ‚ÐºÐµ - Ð½ÑƒÐ¶Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ baseline
          if [[ "${{ steps.snapshot-cache.outputs.cache-hit }}" != "true" ]]; then
            if [[ "${{ github.ref_name }}" == "main" ]] || [[ "${{ github.ref_name }}" =~ ^release/ ]]; then
              UPDATE=true
              echo "âœ… No baseline cache found for ${{ github.ref_name }} - will generate"
            fi
          fi
          
          # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· workflow_dispatch
          if [[ "${{ github.event.inputs.update-snapshots }}" == "true" ]]; then
            UPDATE=true
            echo "âœ… Forced baseline update requested via workflow input"
          fi
          
          echo "update=$UPDATE" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“Š === VRT Configuration ==="
          echo "ðŸ“Š Should update baseline: $UPDATE"
          echo "ðŸ“Š Event: ${{ github.event_name }}"
          echo "ðŸ“Š Branch: ${{ github.ref_name }}"
          echo "ðŸ“Š Cache hit: ${{ steps.snapshot-cache.outputs.cache-hit }}"
          echo "ðŸ“Š Force update flag: ${{ github.event.inputs.update-snapshots }}"

      - name: Generate baseline snapshots
        if: steps.should-update.outputs.update == 'true'
        working-directory: packages/components
        run: |
          echo "ðŸŽ¨ Generating baseline screenshots..."
          pnpm vrt:update

      - name: Optimize PNG screenshots
        if: steps.should-update.outputs.update == 'true'
        run: |
          echo "ðŸ—œï¸ Optimizing PNG files..."
          sudo apt-get install -y pngquant
          find packages/components/vrt/__screenshots__ -name "*.png" -exec pngquant --force --ext .png --quality 70-80 --speed 1 {} \;
          echo "âœ… PNG optimization complete"

      - name: Commit baseline updates
        if: steps.should-update.outputs.update == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain packages/components/vrt/__screenshots__) ]]; then
            echo "ðŸ“ Committing baseline updates..."
            git add packages/components/vrt/__screenshots__
            git commit -m "chore(vrt): update baseline screenshots [skip ci]"
            git push
            echo "âœ… Baseline committed and pushed"
          else
            echo "â„¹ï¸ No baseline changes to commit"
          fi

      - name: Run visual regression tests
        if: steps.should-update.outputs.update != 'true'
        working-directory: packages/components
        continue-on-error: true
        id: vrt-test
        run: |
          echo "ðŸ§ª Running VRT tests..."
          pnpm vrt

      - name: Check VRT approval in PR description
        if: github.event_name == 'pull_request' && steps.vrt-test.outcome == 'failure'
        id: check-approval
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const body = pr.body || '';
            const vrtApproved = /- \[x\] .*visual regression/i.test(body) || 
                               /- \[x\] .*VRT/i.test(body) ||
                               /- \[x\] .*Checked for visual regressions/i.test(body);
            
            core.setOutput('approved', vrtApproved);
            
            if (vrtApproved) {
              console.log('âœ… VRT checkbox is checked - visual changes approved');
            } else {
              console.log('âš ï¸ VRT checkbox is NOT checked');
            }

      - name: Evaluate VRT results
        if: github.event_name == 'pull_request' && steps.vrt-test.outcome == 'failure'
        run: |
          if [[ "${{ steps.check-approval.outputs.approved }}" == "true" ]]; then
            echo "âœ… Visual changes detected but approved by PR author"
            exit 0
          else
            echo "âŒ Visual changes detected and not approved"
            echo ""
            echo "Please:"
            echo "1. Review the visual differences in the test artifacts"
            echo "2. If changes are intentional, check the VRT checkbox in PR description"
            echo "3. If changes are unintentional, fix your code"
            exit 1
          fi

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-components-${{ github.run_id }}
          path: packages/components/test-results
          retention-days: 14

      - name: Upload diff screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-components-${{ github.run_id }}
          path: |
            packages/components/test-results/**/*-diff.png
            packages/components/test-results/**/*-actual.png
            packages/components/test-results/**/*-expected.png
          retention-days: 14

      - name: Comment PR with VRT results
        if: github.event_name == 'pull_request' && steps.vrt-test.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ“¸ Visual Regression Test Results
            
            Visual changes detected! Please review the screenshots in the artifacts.
            
            **Action Required:**
            - Review the visual differences in the [test artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - If changes are intentional, check the "Checked for visual regressions" checkbox in the PR description
            - If changes are unintentional, update your code to match the baseline
            
            [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š VRT Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Baseline updated:** ${{ steps.should-update.outputs.update }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache hit:** ${{ steps.snapshot-cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY