###
#
# Create a pull request with up-to-date icon SVGs
#
# This workflow does not have secrets access
# when run from a fork. Artifacts are uploaded
# and used in a subsequent workflow with more
# privileges which does not run unsafe commands.
#
# https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
#
###

name: Fetch Icons

on:
  schedule:
    - cron: '* * * * 0'

env:
  USER_NAME: github-actions[bot]
  USER_EMAIL: github-actions@github.com
  BRANCH_NAME: update-icon-svgs
  COMMIT_MESSAGE: |
    chore(icons): :point_up: update icon SVGs

jobs:
  fetch:
    runs-on: ubuntu-latest

    outputs:
      icon_changed: ${{ steps.changed-files.outputs.any_changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup
        uses: swisspost/design-system/.github/actions/setup-pnpm@main

      - name: Date Branch Name
        run: echo "BRANCH_NAME=$(date +'%Y-%m-%d')-$(echo $BRANCH_NAME)" >> $GITHUB_ENV

      - name: Create Branch
        run: git checkout -b $BRANCH_NAME

      - name: Fetch Icons
        run: pnpm --filter design-system-icons fetchSVGs

      - name: Get Changes
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          files: ./packages/icons/public/svg/**

      - name: Count Changes
        run: |
          echo "::set-output name=deleted_count::$(steps.changed-files.outputs.any_changed | length)"

  push:
    runs-on: ubuntu-latest
    needs: fetch
    if: needs.fetch.outputs.icon_changed == 'true'

    steps:
      - name: Commit Changes
        run: |
          git config --global user.email $USER_EMAIL
          git config --global user.name $USER_NAME
          git add .
          git commit -am $COMMIT_MESSAGE
          git push -u origin $BRANCH_NAME

      - name: Create PR
        run: gh pr create --title $COMMIT_MESSAGE --body ""
