###
#
# Run snapshot tests with percy
#
# This workflow only runs when triggered manually
#
###

name: Run snapshot tests
on: workflow_dispatch

jobs:
  snapshots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup
        uses: swisspost/design-system/.github/actions/setup-pnpm@main
        with:
          use_cache: false

      - name: Bootstrap
        run: pnpm bootstrap

      - name: Install http-server
        run: pnpm -g add http-server

      # Takes full snapshots on the main and partial snapshots (using the filter) on every other branch
      - name: Take snapshots
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            pnpm exec start-server-and-test 'http-server packages/documentation/storybook-static --silent --port 9300' 9300 'pnpm --no-bail --filter "...[origin/main]" --workspace-concurrency=1 snapshots'
          else
            pnpm exec start-server-and-test 'http-server packages/documentation/storybook-static --silent --port 9300' 9300 'pnpm -r --no-bail --workspace-concurrency=1 snapshots'
          fi
