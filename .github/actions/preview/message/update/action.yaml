name: Update preview message
description: Add a preview url to the existing preview comment, if not already present

inputs:
  access-token:
    description: The access token to use for commenting.
    required: true
  preview-url:
    description: The preview url to add in the comment.
    required: true

runs:
  using: composite
  steps:
    - uses: actions/github-script@v7
      env:
        PREVIEW_URL: ${{ inputs.preview-url }}
      with:
        # github-token: ${{ inputs.access-token }}
        script: |
          const commentTitle = '**Related Previews**'
          const commentInitialBody = 'Preview URLs will be added here, once they are ready... ![loader](https://github.com/swisspost/design-system/assets/9716662/49a75898-7093-4ffb-9460-071ff194459d)'

          const credentials = {
            repo: context.repo.repo,
            owner: context.repo.owner,
            issue_number: context.issue.number
          }

          const comments = (await github.rest.issues.listComments({ ...credentials })).data || []
          const previewComment = comments.find(c => c.body.includes(commentTitle))

          if (previewComment) {
            const hasPreviewUrl = body.includes(PREVIEW_URL)

            if (!hasPreviewUrl) {
              const body = previewComment.body
                .replace(commentInitialBody, '')
                .concat(`- ${PREVIEW_URL}\n`)

              github.rest.issues.updateComment({
                ...credentials,
                body: body
              })
            }
          }
