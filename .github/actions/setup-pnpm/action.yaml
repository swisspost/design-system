###
#
# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
#
# https://docs.github.com/en/actions/creating-actions/about-custom-actions#using-release-management-for-actions
#
# NOTE: pnpm caching support requires pnpm version >= 6.10.0
#
###

name: Setup pnpm
description: Provides node and pnpm in a specific version.

inputs:
  node_version:
    description: Specify the node version to install
    type: string
  pnpm_version:
    description: Specify the pnpm version to install
    type: string
  use_cache:
    description: Specify wether to use the pnpm cache or not
    default: true
    type: boolean

runs:
  using: composite
  steps:
    - name: Detect wanted version
      id: wanted-versions
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs')
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'))

          return {
            node: pkg.engines?.node,
            pnpm: pkg.engines?.pnpm
          }

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ inputs.pnpm_version || fromJSON(steps.wanted-versions.outputs.result).pnpm }}

    - name: Install node with pnpm cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version || fromJSON(steps.wanted-versions.outputs.result).node }}
        cache: ${{ inputs.use_cache == 'true' && 'pnpm' || '' }}
